<!DOCTYPE html>
<html>
<head> 
    <meta charset="utf-8">    
    <script src='../js/d3.min.js'></script>
    <script src='../js/crossfilter.min.js'></script>
    <script src='../js/dc.min.js'></script>

    <style src='../css/dc.css'></style>
    <style>

        /** Curso **/
        #main {
            /** max-width: 1000px; **/
            margin: 0 auto; 
            /**border: 1px solid #ccc;**/
            position: relative;
            
        }

        #grafico1{
            float: left;
            width: 50%;
            font-size: 12px;
        }

         #grafico2{
            margin-left: 50%;
            font-size: 12px;
        }

        * {
          -webkit-box-sizing: border-box;
             -moz-box-sizing: border-box;
                  box-sizing: border-box;
        }

    </style>
</head>
<body>


     <div id="main">
            <div id="titulo">
                 <div class="row">
                    <h3>Atividades Lançadas</h3>
                    <div>Dados obtidos no período de 01/01/2019 a 07/08/2019</div>
                </div>
            <div>
            <div class="dc-data-count">
                <span class="filter-count"></span> selecionados de <span class="total-count"></span> registros | 
                <a href="javascript:dc.filterAll(); dc.renderAll();">Resetar tudo</a>
            </div>
            <p/>
            <div id="grafico1">
                <div id="mesChart" class="chart">
                    <strong>Mês: </strong>
                    <a class="reset" href="javascript:mesChart.filterAll(); dc.redrawAll();" style="display:none;"> resetar</a>
                    <div class="clearfix"></div>
                </div>
            </div>
            <div id="grafico2">
                 <div id="hour-chart" class="chart">
                    <strong>Hora: </strong>
                    <a class="reset" href="javascript:horaChart.filterAll(); dc.redrawAll();" style="display:none;"> resetar</a>
                    <div class="clearfix"></div>
                </div>
            </div>

            <div id="grafico1">
                <div id="vencidoChart" class="chart">
                    <strong>Prazo vencido: (em dias) </strong>
                    <a class="reset" href="javascript:vencidosChart.filterAll(); dc.redrawAll();" style="display:none;"> resetar</a>
                    <div class="clearfix"></div>
                </div>
                <div id="usuarioChart">
                    <strong>Usuário: </strong>
                    <span class="reset" style="display:none;"> <span class="filter"></span></span>
                    <a class="reset" href="javascript:usuarioChart.filterAll(); dc.redrawAll();" style="display:none;"> resetar</a>
                    <div class="clearfix"></div>
                </div>
            </div>


            <div id="grafico1">
                 <div id="setorChart">
                    <strong>Coordenação: </strong>
                    <span class="reset" style="display:none;"> <span class="filter"></span></span>
                    <a class="reset" href="javascript:setorChart.filterAll(); dc.redrawAll();" style="display:none;"> resetar</a>
                    <div class="clearfix"></div>
                </div>
                <div id="movimentoChart">
                    <strong>Tarefas: </strong>
                    <span class="reset" style="display:none;"> <span class="filter"></span></span>
                    <a class="reset" href="javascript:movimentoChart.filterAll(); dc.redrawAll();" style="display:none;"> resetar</a>
                    <div class="clearfix"></div>
                </div>
            </div>


     </div>   


    <script>
    
        //charts
        var usuarioChart    = dc.rowChart("#usuarioChart"),
            setorChart      = dc.rowChart("#setorChart"),
            movimentoChart  = dc.rowChart("#movimentoChart"),
            mesChart        = dc.barChart("#mesChart"),
            horaChart       = dc.barChart("#hour-chart"),
            vencidosChart   = dc.barChart("#vencidoChart"),
            count           = dc.dataCount(".dc-data-count");


         //Id;NUP;Tarefa_id;Setor;Usuario;Especie;Dia_hora
        const allData = Promise.all([
             //tarefas
            d3.csv("../data/sapiens/tarefas.csv"),
            //atividades
            d3.csv("../data/sapiens/atividades.csv")
        ]);


       
        allData.then(data => {

            var tarefas     = data[0],
                atividades  = data[1];

             
            //efetuar melhoria no join de tabelas
            var dados = join(tarefas, atividades, "tarefa_id", "tarefa_id", function(d, t) {
                return {
                  id:           d.Id,
                  nup:          d.NUP,
                  t_id:         d.tarefa_id,
                  setor:        d.Setor,
                  usuario:      nomeDeLogin(d.Usuario),
                  movimento:    d.Especie,
                  prazo_i:      (t !== undefined) ? parseDate(t.Inicio_prazo) : null,
                  prazo_f:      (t !== undefined) ? parseDate(t.Final_prazo) : null,
                  data:         parseDate(d.Dia_hora)
                }
            });
   

            /**tratamento da data
            dados.forEach(d =>{
                d.data = parseDate(d.data);
            })**/

            var ndx = crossfilter(dados);
            var all = ndx.groupAll();

            var movimentoDim = ndx.dimension(function(d){
                return d.movimento;
            })

            var usuarioDim = ndx.dimension(function(d){
                return d.usuario;
            });

            //atividades encerradas apos o prazo final
            var atrasoDim = ndx.dimension(function(e){
                return daysBetween(e.data, e.prazo_f)
            })

            /** var dataDim = ndx.dimension(function(d){
                return d.data;
            })**/

            var horaDim = ndx.dimension(function(d){
                return d.data.getHours() + d.data.getMinutes() / 60;
            })

            var mesDim = ndx.dimension(function(d){
                return d.data.getMonth();
            })

            var coordenacaoDim = ndx.dimension(function(d){
                return d.setor;
            })

            var movimentoGroup      = movimentoDim.group();
            var usuarioGroup        = usuarioDim.group();
            var atrasoGroup         = atrasoDim.group();
            var horaGroup           = horaDim.group(Math.floor);
            var mesGroup            = mesDim.group();
            var coordenacaoGroup    = coordenacaoDim.group();

            usuarioChart
                .height(1800)
                .dimension(usuarioDim)
                .group(usuarioGroup)
                .elasticX(true);

            setorChart
                .height(700)
                .dimension(coordenacaoDim)
                .group(coordenacaoGroup)
                .elasticX(true);

             movimentoChart
                .height(2800)
                .dimension(movimentoDim)
                .group(movimentoGroup)
                .elasticX(true);

             horaChart
                .dimension(horaDim)
                //.width(500)
                .group(horaGroup)
                .elasticY(true)
                .options ({
                  'width' : 500,
                  'height' : 200
                })  
              .x(d3.scaleLinear()
                .domain([0, 24])
                .rangeRound([0, 10 * 24]));

               vencidosChart
                   .dimension(atrasoDim)
                    //.width(500)
                    .group(atrasoGroup)
                    .elasticY(true)
                    .options ({
                      'width' : 500,
                      'height' : 200
                    })  
                  .x(d3.scaleLinear()
                    .domain([-10, 20])); //ate 20 dias
                    //.rangeRound([0, 10 * 24])); 

                mesChart
                    .dimension(mesDim)
                    .width(500)
                    .group(mesGroup)
                    .elasticY(true)
                  .x(d3.scaleLinear()
                    .domain([1, 12]));

                horaChart.margins().left = 50;    
                mesChart.margins().left = 50;   
                vencidosChart.margins().left = 50;       
 
              count
                .dimension(ndx)
                .group(all);    


            dc.renderAll();    

        }) 

        function nomeDeLogin(nome){
           // return nome;
            let array = nome.trim().split(" ");
            return array[0] + " " + array[array.length-1];

        }

        function daysBetween(one, another) {
          return Math.round((one - another)/8.64e7);
        }

        function reduzir(mov){
            if(mov.length > 80){
                return mov.substring(0, 80).concat("...");
            }
        }

         // new Date(ano, mês, dia, hora, minuto, segundo, milissegundo);
        function parseDate(data){

           // if(data == undefined) return;

            let Y = data.substring(6,10); 
            let m = data.substring(3,5)-1; //mes comeca com zero
            let d = data.substring(0,2);

            let h  = data.substring(11,13);
            let mn = data.substring(14,16);
            let s  = data.substring(17,19);

            return new Date(Y, m, d, h, mn, s);
        }   

        function join(lookupTable, mainTable, lookupKey, mainKey, select) {
            var l = lookupTable.length,
                m = mainTable.length,
                lookupIndex = [],
                output = [];
            for (var i = 0; i < l; i++) { // loop through l items
                var row = lookupTable[i];
                lookupIndex[row[lookupKey]] = row; // create an index for lookup table
            }
            for (var j = 0; j < m; j++) { // loop through m items
                var y = mainTable[j];
                var x = lookupIndex[y[mainKey]]; // get corresponding row from lookupTable
                output.push(select(y, x)); // select only the columns you need
            }
            return output;
        };

    </script>
    <!-- Global site tag (gtag.js) - Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=UA-145326356-1"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());

      gtag('config', 'UA-145326356-1');
    </script>
</body>
</html>